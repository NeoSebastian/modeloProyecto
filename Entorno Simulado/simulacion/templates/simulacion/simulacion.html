{% extends 'simulacion/topBar.html' %}

{% block title %}Entorno Simulado - Simulación{% endblock %}

{% block content %}
<!-- Añadir input oculto para el token CSRF -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<h1>Simulación</h1>
<div class="actions">
    <p>Selecciona un emprendimiento para realizar una simulación, ingresando publicaciones manualmente.</p>
    <button onclick="mostrarModalGenerarEmbeddings()">Generar Embeddings</button>
</div>
<table>
    <thead>
        <tr>
            <th>Seleccionar</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Publicaciones</th>
            <th>Comentarios</th>
        </tr>
    </thead>
    <tbody>
        {% for emprendimiento in emprendimientos %}
        <tr>
            <td data-label="Seleccionar">
                <input type="radio" name="emprendimiento" value="{{ emprendimiento.id_emprendimiento }}"
                       data-id="{{ emprendimiento.id_emprendimiento }}"
                       data-nombre="{{ emprendimiento.nombre_emprendimiento|escapejs }}"
                       data-descripcion="{{ emprendimiento.descripcion|default:'Sin descripción'|truncatechars:100|escapejs }}"
                       data-municipio="{{ emprendimiento.id_municipio_origen.municipio|escapejs }}"
                       data-alcance="{{ emprendimiento.id_alcance.tipo|escapejs }}"
                       data-tematicas="{{ emprendimiento.tematicas.all|join:', '|escapejs }}"
                       onchange="mostrarModal(this)">
            </td>
            <td data-label="Nombre">{{ emprendimiento.nombre_emprendimiento }}</td>
            <td data-label="Descripción">{{ emprendimiento.descripcion|default:"Sin descripción"|truncatechars:100 }}</td>
            <td data-label="Publicaciones">{{ emprendimiento.num_publicaciones }}</td>
            <td data-label="Comentarios">{{ emprendimiento.num_comentarios }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" style="text-align: center;">No hay emprendimientos disponibles.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Modal para mostrar detalles del emprendimiento -->
<div id="modal-emprendimiento" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h2>Detalles del Emprendimiento</h2>
        <p><strong>ID:</strong> <span id="modal-id"></span></p>
        <p><strong>Nombre:</strong> <span id="modal-nombre"></span></p>
        <p><strong>Descripción:</strong> <span id="modal-descripcion"></span></p>
        <p><strong>Municipio:</strong> <span id="modal-municipio"></span></p>
        <p><strong>Alcance:</strong> <span id="modal-alcance"></span></p>
        <p><strong>Temáticas:</strong> <span id="modal-tematicas"></span></p>
        <button onclick="realizarSimulacion()">Realizar Simulación</button>
    </div>
</div>

<!-- Modal para ingresar publicaciones manualmente -->
<div id="modal-ingresar-publicaciones" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalIngresarPublicaciones()">&times;</span>
        <h2>Ingresar Publicaciones</h2>
        <p>Ingrese las publicaciones para el emprendimiento en la caja de texto, usando el formato: <strong>(publicación 1), (publicación 2), ...</strong>. Cada publicación debe estar entre paréntesis y separada por comas. Luego, puede guardar las publicaciones o continuar a ver las publicaciones existentes.</p>
        <textarea id="publicaciones-texto" rows="10" style="width: 100%; resize: vertical;"></textarea>
        <div class="modal-actions">
            <button onclick="guardarPublicaciones()">Guardar Publicaciones</button>
            <button onclick="continuarAPublicaciones()">Continuar a Publicaciones</button>
            <button onclick="cerrarModalIngresarPublicaciones()">Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal para ver publicaciones -->
<div id="modal-ver-publicaciones" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalVerPublicaciones()">&times;</span>
        <h2>Publicaciones del Emprendimiento</h2>
        <div id="loading" style="display: none; text-align: center;">
            <p>Cargando publicaciones...</p>
        </div>
        <table id="publicaciones-table">
            <thead>
                <tr>
                    <th>Seleccionar</th>
                    <th>ID Publicación</th>
                    <th>Contenido</th>
                    <th>Comentarios</th>
                </tr>
            </thead>
            <tbody id="publicaciones-lista"></tbody>
        </table>
        <div class="modal-actions">
            <button onclick="cerrarModalVerPublicaciones()">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal para generar embeddings -->
<div id="modal-generar-embeddings" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalGenerarEmbeddings()">&times;</span>
        <h2>Generar Embeddings</h2>
        <p>Los siguientes emprendimientos no tienen embeddings generados:</p>
        <ul id="lista-emprendimientos-sin-embeddings"></ul>
        <div id="loading-embeddings" style="display: none; text-align: center;">
            <p>Generando embeddings...</p>
        </div>
        <div id="error-embeddings" style="display: none; color: red;"></div>
        <div class="modal-actions">
            <button onclick="confirmarGenerarEmbeddings()">Confirmar</button>
            <button onclick="cerrarModalGenerarEmbeddings()">Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal para mostrar el loading de generación de embeddings -->
<div id="modal-loading-embeddings" class="modal">
    <div class="modal-content">
        <h2>Generando Embeddings</h2>
        <div style="text-align: center;">
            <div class="spinner"></div>
            <p>Tiempo transcurrido: <span id="timer">0</span> segundos</p>
        </div>
    </div>
</div>

<style>
    .actions {
        margin-bottom: 20px;
    }
    .actions button {
        padding: 8px 16px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background-color: #2776F5;
        color: white;
    }
    .actions button:hover {
        background-color: #488DFA;
    }
    .actions button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }
    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
        color: #333;
    }
    tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    tr:hover {
        background-color: #f1f1f1;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
    }
    .modal-content button {
        padding: 8px 16px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background-color: #2776f5;
        color: white;
        margin: 5px;
    }
    .modal-content button:hover {
        background-color: #488DFA;
    }
    .modal-actions {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
    }
    #publicaciones-table {
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
    }
    #publicaciones-texto {
        padding: 10px;
        font-size: 14px;
    }
    #loading, #loading-embeddings {
        padding: 20px;
    }
    #lista-emprendimientos-sin-embeddings {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 20px;
    }
    #error-embeddings {
        margin-bottom: 20px;
    }
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2776F5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    @media (max-width: 768px) {
        table, thead, tbody, th, td, tr {
            display: block;
        }
        th, td {
            padding: 10px;
            box-sizing: border-box;
            width: 100%;
        }
        th {
            display: none;
        }
        td {
            text-align: right;
            position: relative;
            padding-left: 50%;
        }
        td:before {
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%;
            font-weight: bold;
            text-align: left;
        }
        .actions button, .modal-content button {
            width: 100%;
            margin: 5px 0;
        }
        .modal-actions {
            flex-direction: column;
        }
    }
</style>

<script>
let currentEmprendimientoId = null;
let timerInterval = null;

function mostrarModal(input) {
    const id = input.getAttribute('data-id');
    const nombre = input.getAttribute('data-nombre');
    const descripcion = input.getAttribute('data-descripcion');
    const municipio = input.getAttribute('data-municipio');
    const alcance = input.getAttribute('data-alcance');
    const tematicas = input.getAttribute('data-tematicas');
    
    currentEmprendimientoId = id;
    document.getElementById('modal-id').textContent = id;
    document.getElementById('modal-nombre').textContent = nombre;
    document.getElementById('modal-descripcion').textContent = descripcion;
    document.getElementById('modal-municipio').textContent = municipio;
    document.getElementById('modal-alcance').textContent = alcance;
    document.getElementById('modal-tematicas').textContent = tematicas;
    document.getElementById('modal-emprendimiento').style.display = 'block';
}

function cerrarModal() {
    document.getElementById('modal-emprendimiento').style.display = 'none';
    currentEmprendimientoId = null;
}

function realizarSimulacion() {
    if (!currentEmprendimientoId) {
        alert('Por favor, selecciona un emprendimiento primero.');
        return;
    }
    window.location.href = `/simulacion/publicaciones/${currentEmprendimientoId}/`;
}

function cerrarModalIngresarPublicaciones() {
    document.getElementById('modal-ingresar-publicaciones').style.display = 'none';
}

function guardarPublicaciones() {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrftoken) {
        alert('Error: Token CSRF no encontrado');
        return;
    }

    const publicacionesTexto = document.getElementById('publicaciones-texto').value;
    if (!publicacionesTexto.trim()) {
        alert('Por favor, ingrese al menos una publicación.');
        return;
    }

    document.getElementById('modal-ingresar-publicaciones').querySelector('.modal-actions').style.display = 'none';
    const loading = document.createElement('div');
    loading.innerHTML = '<p>Guardando publicaciones...</p>';
    document.getElementById('modal-ingresar-publicaciones').appendChild(loading);

    fetch('/simulacion/simulacion/guardar-publicaciones/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
        },
        body: 'id_emprendimiento=' + encodeURIComponent(currentEmprendimientoId) + 
              '&publicaciones=' + encodeURIComponent(publicacionesTexto)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            document.getElementById('modal-ingresar-publicaciones').removeChild(loading);
            document.getElementById('modal-ingresar-publicaciones').querySelector('.modal-actions').style.display = 'flex';
            continuarAPublicaciones();
        } else {
            throw new Error(data.message);
        }
    })
    .catch(error => {
        alert('Error al guardar publicaciones: ' + error.message);
        document.getElementById('modal-ingresar-publicaciones').removeChild(loading);
        document.getElementById('modal-ingresar-publicaciones').querySelector('.modal-actions').style.display = 'flex';
    });
}

function continuarAPublicaciones() {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrftoken) {
        alert('Error: Token CSRF no encontrado');
        return;
    }

    document.getElementById('loading').style.display = 'block';
    document.getElementById('publicaciones-lista').innerHTML = '';
    document.getElementById('modal-ver-publicaciones').style.display = 'block';

    fetch('/simulacion/ver-publicaciones/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
        },
        body: 'id_emprendimiento=' + encodeURIComponent(currentEmprendimientoId)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('loading').style.display = 'none';
        if (data.status === 'success') {
            const lista = document.getElementById('publicaciones-lista');
            data.publicaciones.forEach(pub => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Seleccionar">
                        <input type="radio" name="publicacion" value="${pub.id_publicacion}" 
                               data-id="${pub.id_publicacion}" onchange="seleccionarPublicacion(this)">
                    </td>
                    <td data-label="ID Publicación">${pub.id_publicacion}</td>
                    <td data-label="Contenido">${pub.contenido}</td>
                    <td data-label="Comentarios">${pub.num_comentarios}</td>
                `;
                lista.appendChild(tr);
            });
        } else {
            alert('Error: ' + data.message);
            cerrarModalVerPublicaciones();
        }
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        alert('Error al cargar publicaciones: ' + error.message);
        cerrarModalVerPublicaciones();
    });
}

function seleccionarPublicacion(input) {
    const idPublicacion = input.getAttribute('data-id');
    console.log('Publicación seleccionada:', idPublicacion);
}

function cerrarModalVerPublicaciones() {
    document.getElementById('modal-ver-publicaciones').style.display = 'none';
}

function mostrarModalGenerarEmbeddings() {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrftoken) {
        alert('Error: Token CSRF no encontrado');
        return;
    }

    document.getElementById('lista-emprendimientos-sin-embeddings').innerHTML = '';
    document.getElementById('error-embeddings').style.display = 'none';
    document.getElementById('loading-embeddings').style.display = 'block';
    document.getElementById('modal-generar-embeddings').style.display = 'block';

    fetch('/simulacion/check_missing_embeddings/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading-embeddings').style.display = 'none';
        const lista = document.getElementById('lista-emprendimientos-sin-embeddings');
        if (data.emprendimientos_sin_embeddings.length > 0) {
            data.emprendimientos_sin_embeddings.forEach(emp => {
                const li = document.createElement('li');
                li.textContent = `ID: ${emp.id_emprendimiento} - ${emp.nombre_emprendimiento}`;
                lista.appendChild(li);
            });
        } else {
            lista.innerHTML = '<li>No hay emprendimientos nuevos sin embeddings.</li>';
            document.querySelector('#modal-generar-embeddings .modal-actions').style.display = 'none';
        }
    })
    .catch(error => {
        document.getElementById('loading-embeddings').style.display = 'none';
        alert('Error al cargar emprendimientos: ' + error.message);
        cerrarModalGenerarEmbeddings();
    });
}

function cerrarModalGenerarEmbeddings() {
    document.getElementById('modal-generar-embeddings').style.display = 'none';
}

function cerrarModalLoadingEmbeddings() {
    document.getElementById('modal-loading-embeddings').style.display = 'none';
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function confirmarGenerarEmbeddings() {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrftoken) {
        alert('Error: Token CSRF no encontrado');
        return;
    }

    // Mostrar modal de loading y empezar el temporizador
    document.getElementById('modal-generar-embeddings').style.display = 'none';
    document.getElementById('modal-loading-embeddings').style.display = 'block';
    let seconds = 0;
    document.getElementById('timer').textContent = seconds;
    timerInterval = setInterval(() => {
        seconds++;
        document.getElementById('timer').textContent = seconds;
    }, 1000);

    fetch('/simulacion/generar_embeddings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        cerrarModalLoadingEmbeddings();
        if (data.status === 'success') {
            alert('Embeddings generados exitosamente');
            cerrarModalGenerarEmbeddings();
            // Actualizar el estado del enlace de Predicciones
            const prediccionesLink = document.getElementById('predicciones-link');
            prediccionesLink.classList.remove('disabled');
            prediccionesLink.onclick = null;
        } else {
            document.getElementById('error-embeddings').style.display = 'block';
            document.getElementById('error-embeddings').textContent = data.message;
            document.getElementById('lista-emprendimientos-sin-embeddings').style.display = 'block';
            document.getElementById('modal-generar-embeddings').style.display = 'block';
        }
    })
    .catch(error => {
        cerrarModalLoadingEmbeddings();
        document.getElementById('error-embeddings').style.display = 'block';
        document.getElementById('error-embeddings').textContent = 'Error al generar embeddings: ' + error.message;
        document.getElementById('lista-emprendimientos-sin-embeddings').style.display = 'block';
        document.getElementById('modal-generar-embeddings').style.display = 'block';
    });
}
</script>
{% endblock %}