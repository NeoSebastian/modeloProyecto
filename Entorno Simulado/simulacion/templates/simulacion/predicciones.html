{% extends 'simulacion/topBar.html' %}
{% load static %}
{% load django_bootstrap5 %}
{% block title %}Entorno Simulado - Predicciones{% endblock %}
{% block content %}
{% bootstrap_css %}
{% bootstrap_javascript %}

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<!-- Main Container -->
<div class="container-fluid py-4 bg-light min-vh-100">
  <div class="row g-4">
    <!-- Graph Container (Left, 70%) -->
    <div class="col-md-8">
      <div class="card shadow-sm border" style="border-color: black; border-width: 2px;">
        <div class="card-body p-2 position-relative">

          <div id="graph-error" class="alert alert-warning m-3" style="display: none;">
            No se pudieron cargar los datos del grafo. Verifica la consola para m치s detalles.
          </div>
          <div id="graph" style="width: 100%; height: 60vh; background: #f8f9fa; overflow: visible;"></div>
        </div>
      </div>
    </div>

    <!-- Sidebar (Right, 30%) -->
    <div class="col-md-4">
      <!-- Search and Config Card -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">Controles</h5>
        </div>
        <div class="card-body">
          <!-- Model Selection -->
          <div class="input-group mb-3" style="max-width: 550px;">
            <span class="input-group-text bg-primary text-white border-0">
              <i class="bi bi-cpu me-2"></i>Modelo
            </span>
            <select id="model-select" class="form-select border-primary">
              {% for mf in model_files %}
                <option value="{{ mf }}" {% if mf == default_model %}selected{% endif %}>{{ mf }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-primary" id="reload-btn">
              <i class="bi bi-arrow-repeat me-2"></i>Cargar
            </button>
          </div>
          <!-- Search -->
          <div class="mb-3">
            <div class="input-group">
              <span class="input-group-text bg-primary text-white border-0">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" id="search-input" class="form-control" placeholder="Buscar por nombre, ID o tem치tica...">
            </div>
            <div id="search-results" class="list-group mt-2" style="display: none; max-height: 200px; overflow-y: auto;"></div>
          </div>
          <!-- Config -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#config-panel" aria-expanded="false" aria-controls="config-panel">
              <i class="bi bi-gear-fill me-2"></i>Configuraci칩n
            </button>
            <!-- Algorithm Selection -->
            <div class="dropdown">
              <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Algoritmo
              </button>
              <ul class="dropdown-menu">
                <li><button class="dropdown-item active" onclick="selectAlgo('recommendations')">游댌 Recomendaciones</button></li>
                <li><button class="dropdown-item" onclick="selectAlgo('community')">游빌 An치lisis de Comunidades</button></li>
                <li><button class="dropdown-item" onclick="selectAlgo('clustering')">游늵 Clusterizaci칩n</button></li>
              </ul>
            </div>
          </div>
          <!-- Config Panel -->
          <div class="collapse mt-3" id="config-panel">
            <div class="card card-body border-0 shadow-sm">
              <h6 class="fw-bold">Ajustes Avanzados</h6>
              <div class="mb-3">
                <label for="followers-range" class="form-label">Rango de Seguidores:</label>
                <input type="range" id="followers-range" class="form-range" min="0" max="{{ max_followers|default:1000 }}" value="0">
                <span id="followers-value" class="text-muted">0</span>
              </div>
              <div class="mb-3">
                <label for="municipio-filter" class="form-label">Filtro Geogr치fico:</label>
                <select id="municipio-filter" class="form-select" multiple>
                  {% for municipio in municipios %}
                    <option value="{{ municipio.id_municipio }}">{{ municipio.municipio }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="clustering-type" class="form-label">Tipo de Clustering:</label>
                <select id="clustering-type" class="form-select">
                  <option value="kmeans">K-Means</option>
                  <option value="agglomerative">Agglomerative</option>                  
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs Card -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">Detalles</h5>
        </div>
        <div class="card-body p-0">
          <ul class="nav nav-tabs">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#summary">Resumen</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#recommendations">Recomendaciones</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#community">Comunidad</button>
            </li>
          </ul>
          <div class="tab-content p-2" style="max-height: 50vh; overflow-y: auto;">
            <div class="tab-pane fade show active" id="summary">
              <h5 class="fw-bold mb-3">Resumen del Emprendimiento</h5>
              <div id="summary-content">
                <p class="text-muted">Selecciona un emprendimiento en el grafo.</p>
              </div>
              <canvas id="radar-chart" style="max-height: 200px;"></canvas>
            </div>
            <div class="tab-pane fade" id="recommendations">
              <h5 class="fw-bold mb-3">Recomendaciones Inteligentes</h5>
              <div id="recommendations-content"></div>
            </div>
            <div class="tab-pane fade" id="community">
              <h5 class="fw-bold mb-3">An치lisis de Comunidad</h5>
              <div id="community-content"></div>
              <canvas id="heatmap-chart" style="max-height: 200px;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions Card -->
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex justify-content-between">
          <button onclick="resetGraph()" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-arrow-repeat me-2"></i>Reiniciar Grafo
          </button>
          <button onclick="generateReport()" class="btn btn-primary btn-sm report-btn">
            <i class="bi bi-file-earmark-pdf me-2"></i>Generar Reporte PDF
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Librer칤as -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<style>
/* Minimal custom CSS for specific tweaks */
#graph {
  width: 100%;
  height: 60vh;
  overflow: visible;
}
#graph svg {
  width: 100%;
  height: 100%;
  display: block;
  overflow: visible;
}
.tooltip {
  position: absolute;
  background: white;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  z-index: 1000;
}
.list-group-item:hover {
  background-color: #f8f9fa;
  cursor: pointer;
}
@media (max-width: 768px) {
  #graph {
    height: 50vh;
  }
  .card-body {
    padding: 1rem;
  }
}
</style>

<script>
// Funci칩n para obtener el token CSRF
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
const csrftoken = getCookie('csrftoken');

// Funci칩n para obtener datos de localStorage o del servidor
async function loadGraphData(modelName) {
  const storedData = localStorage.getItem('prediccionesGraphData');
  const storedTimestamp = localStorage.getItem('prediccionesTimestamp');
  const storedModel = localStorage.getItem('prediccionesModel');
  const currentTime = new Date().getTime();
  const cacheDuration = 24 * 60 * 60 * 1000; // 24 horas en milisegundos

  let graphData, emprendimientosData, tematicasData, nCommunities;
  if (storedData && storedTimestamp && storedModel === modelName && (currentTime - storedTimestamp < cacheDuration)) {
    const data = JSON.parse(storedData);
    graphData = data.graphData;
    emprendimientosData = data.emprendimientosData;
    tematicasData = data.tematicasData;
    nCommunities = data.nCommunities;
  } else {
    try {
      const url = new URL("{% url 'simulacion:predicciones_data' %}", window.location.origin);
      url.searchParams.set("model", modelName);
      const response = await fetch(url.toString());
      const data = await response.json();
      if (data.status !== 'ok') throw new Error(data.message || 'Error al cargar los datos');
      graphData = data.graph_data;
      emprendimientosData = data.emprendimientos;
      tematicasData = data.tematicas;
      nCommunities = data.n_communities;
      const dataToStore = { graphData, emprendimientosData, tematicasData, nCommunities };
      localStorage.setItem('prediccionesGraphData', JSON.stringify(dataToStore));
      localStorage.setItem('prediccionesTimestamp', currentTime);
      localStorage.setItem('prediccionesModel', modelName);
    } catch (e) {
      console.error('Error al cargar datos del servidor:', e);
      document.getElementById('graph-error').style.display = 'block';
      document.getElementById('graph-error').textContent = `Error: ${e.message}`;
      return { graphData: { nodes: [], links: [] }, emprendimientosData: [], tematicasData: [], nCommunities: 0 };
    }
  }

  // Validar datos
  if (!graphData || !graphData.nodes || !graphData.links || graphData.nodes.length === 0) {
    console.error('Datos del grafo vac칤os o inv치lidos:', graphData);
    document.getElementById('graph-error').style.display = 'block';
    document.getElementById('graph-error').textContent = 'No se encontraron datos v치lidos para el grafo.';
    return { graphData: { nodes: [], links: [] }, emprendimientosData: [], tematicasData: [], nCommunities: 0 };
  }

  console.log('Datos cargados:', { graphData, emprendimientosData, tematicasData, nCommunities });
  return { graphData, emprendimientosData, tematicasData, nCommunities };
}

// Cargar datos iniciales
let { graphData, emprendimientosData, tematicasData, nCommunities } = { graphData: { nodes: [], links: [] }, emprendimientosData: [], tematicasData: [], nCommunities: 0 };
let selectedNode = null;
let highlightedConnection = null;

const modelSelect = document.getElementById('model-select');
const reloadBtn = document.getElementById('reload-btn');
const defaultModel = "{{ default_model }}";

async function loadAndRender() {
  try {
    const data = await loadGraphData(modelSelect.value);
    graphData = data.graphData;
    emprendimientosData = data.emprendimientosData;
    tematicasData = data.tematicasData;
    nCommunities = data.nCommunities;
    updateGraph();
    document.getElementById('graph-error').style.display = 'none';
  } catch (e) {
    console.error('Error al cargar y renderizar:', e);
    document.getElementById('graph-error').style.display = 'block';
    document.getElementById('graph-error').textContent = `Error al cargar el modelo: ${e.message}`;
  }
}

reloadBtn.addEventListener('click', loadAndRender);

const searchInput = document.getElementById('search-input');
const searchResults = document.getElementById('search-results');
searchInput.addEventListener('input', () => {
  const query = searchInput.value.toLowerCase();
  searchResults.innerHTML = '';
  searchResults.style.display = 'none';
  if (query.length < 2) return;

  const results = emprendimientosData.filter(emp =>
    emp.nombre_emprendimiento?.toLowerCase().includes(query) ||
    emp.id_emprendimiento?.toString().includes(query) ||
    emp.tematicas?.some(t => t.toLowerCase().includes(query))
  );
  results.forEach(emp => {
    const div = document.createElement('div');
    div.className = 'list-group-item';
    div.innerHTML = `
      <strong>${emp.nombre_emprendimiento || 'Sin nombre'}</strong> (ID: ${emp.id_emprendimiento || 'N/A'})<br>
      <small class="text-muted">Seguidores: ${emp.seguidores || 0}, Municipio: ${emp.municipio || 'N/A'}</small>
    `;
    div.onclick = () => selectNode(emp.id_emprendimiento);
    searchResults.appendChild(div);
  });
  searchResults.style.display = results.length ? 'block' : 'none';
});

function selectAlgo(algo) {
  document.querySelectorAll('.dropdown-item').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  colorMode = algo === 'recommendations' ? 'community' : algo;
  updateGraph();
}

let colorMode = 'community';
let clusteringType = 'kmeans';
document.getElementById('followers-range').addEventListener('input', (e) => {
  document.getElementById('followers-value').textContent = e.target.value;
  updateGraph();
});
document.getElementById('clustering-type').addEventListener('change', (e) => {
  clusteringType = e.target.value;
  if (colorMode === 'clustering') updateGraph();
});

const svg = d3.select('#graph').append('svg').attr('width', '100%').attr('height', '100%');
let width = document.querySelector('#graph').offsetWidth;
let height = document.querySelector('#graph').offsetHeight;
const simulation = d3.forceSimulation()
  .force('link', d3.forceLink().id(d => d.id).distance(150))
  .force('charge', d3.forceManyBody().strength(-300))
  .force('center', d3.forceCenter(width / 2, height / 2))
  .force('collide', d3.forceCollide().radius(d => Math.sqrt(d.seguidores || 10) + 15));

const zoom = d3.zoom()
  .scaleExtent([0.5, 3])
  .on('zoom', (event) => {
    svg.selectAll('g').attr('transform', event.transform);
  });
svg.call(zoom);

// Actualizar dimensiones del SVG al redimensionar la ventana
window.addEventListener('resize', () => {
  width = document.querySelector('#graph').offsetWidth;
  height = document.querySelector('#graph').offsetHeight;
  svg.attr('width', width).attr('height', height);
  simulation.force('center', d3.forceCenter(width / 2, height / 2));
  simulation.alpha(1).restart();
});

function updateGraph() {
  svg.selectAll('*').remove();
  const g = svg.append('g');

  // Actualizar dimensiones din치micamente
  width = document.querySelector('#graph').offsetWidth;
  height = document.querySelector('#graph').offsetHeight;
  svg.attr('width', width).attr('height', height);
  simulation.force('center', d3.forceCenter(width / 2, height / 2));

  const minFollowers = +document.getElementById('followers-range').value;
  const selectedMunicipios = Array.from(document.getElementById('municipio-filter').selectedOptions).map(opt => +opt.value);
  
  const filteredNodes = graphData.nodes.filter(node => {
    if (!node.id || !node.seguidores || !node.id_municipio_origen) {
      console.warn('Nodo inv치lido:', node);
      return false;
    }
    return node.seguidores >= minFollowers &&
           (selectedMunicipios.length === 0 || selectedMunicipios.includes(node.id_municipio_origen));
  });
  const nodeIds = new Set(filteredNodes.map(n => n.id));
  const filteredLinks = graphData.links.filter(link => {
    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
    const targetId = typeof link.target === 'object' ? link.target.id : link.target;
    return nodeIds.has(sourceId) && nodeIds.has(targetId);
  });

  console.log('Nodos filtrados:', filteredNodes.length, 'Enlaces filtrados:', filteredLinks.length);

  if (filteredNodes.length === 0) {
    document.getElementById('graph-error').textContent = 'No hay nodos que cumplan con los filtros seleccionados.';
    document.getElementById('graph-error').style.display = 'block';
    return;
  } else {
    document.getElementById('graph-error').style.display = 'none';
  }

  const links = g.append('g').selectAll('line')
    .data(filteredLinks)
    .enter().append('line')
    .attr('stroke', d => {
      const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
      const targetId = typeof d.target === 'object' ? d.target.id : d.target;
      if (highlightedConnection &&
          ((sourceId === highlightedConnection.sourceId && targetId === highlightedConnection.targetId) ||
           (sourceId === highlightedConnection.targetId && targetId === highlightedConnection.sourceId))) {
        return '#FF0000';
      }
      return '#999';
    })
    .attr('stroke-opacity', d => {
      const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
      const targetId = typeof d.target === 'object' ? d.target.id : d.target;
      if (highlightedConnection &&
          ((sourceId === highlightedConnection.sourceId && targetId === highlightedConnection.targetId) ||
           (sourceId === highlightedConnection.targetId && targetId === highlightedConnection.sourceId))) {
        return 1;
      }
      return 0.6;
    })
    .attr('stroke-width', d => {
      const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
      const targetId = typeof d.target === 'object' ? d.target.id : d.target;
      if (highlightedConnection &&
          ((sourceId === highlightedConnection.sourceId && targetId === highlightedConnection.targetId) ||
           (sourceId === highlightedConnection.targetId && targetId === highlightedConnection.sourceId))) {
        return 5;
      }
      return Math.sqrt(d.weight || 1);
    });

  const nodes = g.append('g').selectAll('circle')
    .data(filteredNodes)
    .enter().append('circle')
    .attr('r', d => Math.sqrt(d.seguidores || 10) + 5)
    .attr('fill', d => {
      let clusterValue;
      if (colorMode === 'clustering') {
        if (clusteringType === 'kmeans') {
          clusterValue = d.cluster_kmeans;
        } else if (clusteringType === 'agglomerative') {
          clusterValue = d.cluster_agglomerative;
        } else if (clusteringType === 'dbscan') {
          clusterValue = d.cluster_dbscan;
        }
      } else {
        clusterValue = d.comunidad_louvain;
      }
      if (d.id === selectedNode?.id_emprendimiento) {
        return '#FFD700';
      } else if (highlightedConnection && d.id === highlightedConnection.targetId) {
        return '#FF4500';
      }
      return d3.schemeCategory10[(clusterValue || 0) % 10];
    })
    .attr('stroke', d => d.id === selectedNode?.id_emprendimiento ? '#000000' : null)
    .attr('stroke-width', d => d.id === selectedNode?.id_emprendimiento ? 2 : 0)
    .attr('opacity', d => {
      if (highlightedConnection &&
          (d.id === highlightedConnection.sourceId || d.id === highlightedConnection.targetId)) {
        return 1;
      }
      return highlightedConnection ? 0.3 : 1;
    })
    .call(d3.drag()
      .on('start', dragstarted)
      .on('drag', dragged)
      .on('end', dragended))
    .on('mouseover', function(event, d) {
      if (!highlightedConnection ||
          (d.id !== highlightedConnection.sourceId && d.id !== highlightedConnection.targetId)) {
        d3.select(this).attr('opacity', 1);
      }
      const tooltip = new bootstrap.Tooltip(this, {
        title: `
          <strong>${d.nombre_emprendimiento || 'Sin nombre'}</strong><br>
          Seguidores: ${d.seguidores || 0}<br>
          Popularidad: ${(d.total_likes || 0).toFixed(2)}<br>
          Conectividad: ${(d.degree_centrality || 0).toFixed(2)}
        `,
        html: true,
        placement: 'top'
      });
      tooltip.show();
    })
    .on('mouseout', function(event, d) {
      if (highlightedConnection &&
          (d.id !== highlightedConnection.sourceId && d.id !== highlightedConnection.targetId)) {
        d3.select(this).attr('opacity', 0.3);
      }
      const tooltip = bootstrap.Tooltip.getInstance(this);
      if (tooltip) {
        tooltip.dispose();
      }
    })
    .on('click', (event, d) => selectNode(d.id));

  simulation.nodes(filteredNodes).on('tick', () => {
    nodes.each(d => {
      d.x = Math.max(20, Math.min(width - 20, d.x));
      d.y = Math.max(20, Math.min(height - 20, d.y));
    });

    links
      .attr('x1', d => d.source.x)
      .attr('y1', d => d.source.y)
      .attr('x2', d => d.target.x)
      .attr('y2', d => d.target.y);
    nodes
      .attr('cx', d => d.x)
      .attr('cy', d => d.y);
  });

  simulation.force('link').links(filteredLinks);
  simulation.alpha(1).restart();
}

function dragstarted(event, d) {
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(event, d) {
  d.fx = event.x;
  d.fy = event.y;
}

function dragended(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}

function selectNode(id) {
  selectedNode = emprendimientosData.find(emp => emp.id_emprendimiento === id);
  if (!selectedNode) {
    console.warn('Nodo no encontrado en emprendimientosData:', id);
    return;
  }
  resetGraph();
  updateSidebar();
}

function resetGraph() {
  highlightedConnection = null;
  updateGraph();
}

function updateSidebar() {
  if (!selectedNode) return;

  const summaryContent = document.getElementById('summary-content');
  summaryContent.innerHTML = `
    <p><strong>ID:</strong> ${selectedNode.id_emprendimiento}</p>
    <p><strong>Nombre:</strong> ${selectedNode.nombre_emprendimiento || 'Sin nombre'}</p>
    <p><strong>Descripci칩n:</strong> ${selectedNode.descripcion || 'Sin descripci칩n'}</p>
    <p><strong>Seguidores:</strong> ${selectedNode.seguidores || 0}</p>
    <p><strong>Municipio:</strong> ${selectedNode.municipio || 'N/A'}</p>
    <p><strong>Tem치ticas:</strong> ${selectedNode.tematicas?.join(', ') || 'N/A'}</p>
  `;

  const ctx = document.getElementById('radar-chart').getContext('2d');
  if (ctx.chart) ctx.chart.destroy();
  ctx.chart = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: ['Popularidad', 'Conectividad', 'Diversidad Tem치tica'],
      datasets: [{
        label: selectedNode.nombre_emprendimiento || 'Emprendimiento',
        data: [
          (selectedNode.seguidores || 0) / Number('{{ max_followers|default:1000|escapejs }}') * 100,
          (selectedNode.degree_centrality || 0) * 100,
          (selectedNode.tematicas?.length || 0) / Number('{{ max_tematicas|default:5|escapejs }}') * 100
        ],
        fill: true,
        backgroundColor: 'rgba(76, 175, 80, 0.2)',
        borderColor: '#4CAF50',
        pointBackgroundColor: '#4CAF50'
      }]
    },
    options: {
      scales: { r: { beginAtZero: true, max: 100 } }
    }
  });

  fetch('/simulacion/recommend_emprendimientos/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': csrftoken
    },
    body: `id_emprendimiento=${selectedNode.id_emprendimiento}&model=${modelSelect.value}`
  })
  .then(response => {
    if (!response.ok) throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
    return response.json();
  })
  .then(data => {
    const recContent = document.getElementById('recommendations-content');
    if (data.status === 'success' && data.recommendations && data.recommendations.length > 0) {
      recContent.innerHTML = data.recommendations.map(rec => `
        <div class="mb-2 p-2 border rounded">
          <h6 class="mb-1">${rec.nombre || 'Sin nombre'} (ID: ${rec.id})</h6>
          <p class="mb-1"><strong>Similitud:</strong> ${(rec.similitud * 100).toFixed(1)}%</p>
          <p class="mb-1"><strong>Tem치ticas:</strong> ${rec.tematicas?.join(', ') || 'N/A'}</p>
          <button onclick="viewConnection(${rec.id})" class="btn btn-outline-primary btn-sm w-100">
            <i class="bi bi-link-45deg me-2"></i>Ver Conexi칩n
          </button>
        </div>
      `).join('');
    } else {
      recContent.innerHTML = '<p class="text-muted">No se encontraron recomendaciones disponibles.</p>';
    }
  })
  .catch(error => {
    console.error('Error al cargar recomendaciones:', error);
    document.getElementById('recommendations-content').innerHTML = `<p class="text-danger">Error al cargar recomendaciones: ${error.message}</p>`;
  });

  const community = graphData.nodes.find(n => n.id === selectedNode.id_emprendimiento)?.comunidad_louvain;
  if (community === undefined) {
    document.getElementById('community-content').innerHTML = '<p class="text-muted">No se encontr칩 informaci칩n de comunidad.</p>';
    return;
  }
  const communityEmps = graphData.nodes.filter(n => n.comunidad_louvain === community);
  const topEmps = communityEmps.sort((a, b) => (b.betweenness_centrality || 0) - (a.betweenness_centrality || 0)).slice(0, 5);
  document.getElementById('community-content').innerHTML = `
    <p><strong>Comunidad ${community}</strong> (${communityEmps.length} miembros)</p>
    <p><strong>Tem치ticas principales:</strong> ${selectedNode.tematicas?.join(', ') || 'N/A'}</p>
    <p><strong>Emprendimientos clave:</strong></p>
    ${topEmps.map(emp => `<p>${emp.nombre_emprendimiento || 'Sin nombre'} (Centralidad: ${(emp.betweenness_centrality || 0).toFixed(2)})</p>`).join('')}
    <p><strong>Insight:</strong> Esta comunidad tiene alta densidad en ${selectedNode.tematicas?.[0] || 'tem치ticas variadas'}.</p>
  `;

  const heatmapData = Array.from({ length: nCommunities }, () => Array(nCommunities).fill(0));
  graphData.links.forEach(link => {
    const sourceNode = graphData.nodes.find(n => n.id === (typeof link.source === 'object' ? link.source.id : link.source));
    const targetNode = graphData.nodes.find(n => n.id === (typeof link.target === 'object' ? link.target.id : link.target));
    if (sourceNode && targetNode) {
      const com1 = sourceNode.comunidad_louvain;
      const com2 = targetNode.comunidad_louvain;
      heatmapData[com1][com2] += link.weight || 1;
      heatmapData[com2][com1] += link.weight || 1;
    }
  });

  const heatmapCtx = document.getElementById('heatmap-chart').getContext('2d');
  if (heatmapCtx.chart) heatmapCtx.chart.destroy();
  heatmapCtx.chart = new Chart(heatmapCtx, {
    type: 'matrix',
    data: {
      datasets: [{
        label: 'Conexi칩n entre comunidades',
        data: heatmapData.flatMap((row, i) => row.map((val, j) => ({ x: j, y: i, v: val }))),
        backgroundColor: c => `rgba(54, 162, 235, ${c.raw.v / Math.max(...heatmapData.flat()) || 0})`,
        width: ({ chart }) => chart.chartArea.width / nCommunities,
        height: ({ chart }) => chart.chartArea.height / nCommunities
      }]
    },
    options: {
      scales: {
        x: { title: { display: true, text: 'Comunidad' } },
        y: { title: { display: true, text: 'Comunidad' } }
      }
    }
  });

  document.getElementById('insight-text').innerHTML = selectedNode.seguidores < Number('{{ max_followers|default:1000|escapejs }}') / 4
    ? `丘멆잺 El emprendimiento seleccionado tiene baja conexi칩n con clusters de alto crecimiento.`
    : `游눠 ${selectedNode.nombre_emprendimiento || 'Emprendimiento'} est치 bien conectado en su comunidad.`;
}

function viewConnection(id) {
  if (!selectedNode) {
    alert('Por favor, selecciona un emprendimiento primero.');
    return;
  }
  highlightedConnection = { sourceId: selectedNode.id_emprendimiento, targetId: id };
  updateGraph();
}

function generateReport() {
  if (!selectedNode) {
    alert('Por favor, selecciona un emprendimiento primero.');
    return;
  }
  const btn = document.querySelector('.report-btn');
  const originalText = btn.textContent;
  btn.textContent = 'Generando...';
  btn.disabled = true;

  fetch('/simulacion/generate_pdf_report/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': csrftoken
    },
    body: `id_emprendimiento=${selectedNode.id_emprendimiento}&model=${modelSelect.value}`
  })
  .then(response => {
    if (response.ok) return response.blob();
    throw new Error('Error al generar el reporte');
  })
  .then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `reporte_${selectedNode.id_emprendimiento}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    a.remove();
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error al generar el reporte: ' + error.message);
  })
  .finally(() => {
    btn.textContent = originalText;
    btn.disabled = false;
  });
}

function showTab(tabId) {
  bootstrap.Tab.getOrCreateInstance(document.querySelector(`[data-bs-target="#${tabId}"]`)).show();
}

// Inicial
loadAndRender();
</script>
{% endblock %}