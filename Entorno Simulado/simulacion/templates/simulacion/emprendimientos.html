{% extends 'simulacion/topBar.html' %}

{% block title %}Lista de Emprendimientos{% endblock %}

{% block content %}
<h1>Lista de Emprendimientos</h1>
<div class="filters-and-actions">
    <div class="filters">
        <form method="GET" action="{% url 'simulacion:lista_emprendimientos' %}">
            <select name="municipio">
                <option value="">Todos los municipios</option>
                {% for municipio in municipios %}
                <option value="{{ municipio.id_municipio }}" {% if municipio.id_municipio|stringformat:"s" == request.GET.municipio %}selected{% endif %}>
                    {{ municipio.municipio }}
                </option>
                {% endfor %}
            </select>
            <select name="alcance">
                <option value="">Todos los alcances</option>
                {% for alcance in alcances %}
                <option value="{{ alcance.id_alcance }}" {% if alcance.id_alcance|stringformat:"s" == request.GET.alcance %}selected{% endif %}>
                    {{ alcance.tipo }}
                </option>
                {% endfor %}
            </select>
            <select name="tematica">
                <option value="">Todas las temáticas</option>
                {% for tematica in tematicas %}
                <option value="{{ tematica.id_tematica }}" {% if tematica.id_tematica|stringformat:"s" == request.GET.tematica %}selected{% endif %}>
                    {{ tematica.nombre }}
                </option>
                {% endfor %}
            </select>
            <button type="submit">Filtrar</button>
        </form>
    </div>
    <div class="sort">
        <form method="GET" action="{% url 'simulacion:lista_emprendimientos' %}">
            {% if request.GET.municipio %}
            <input type="hidden" name="municipio" value="{{ request.GET.municipio }}">
            {% endif %}
            {% if request.GET.alcance %}
            <input type="hidden" name="alcance" value="{{ request.GET.alcance }}">
            {% endif %}
            {% if request.GET.tematica %}
            <input type="hidden" name="tematica" value="{{ request.GET.tematica }}">
            {% endif %}
            <select name="sort_by">
                <option value="id_emprendimiento" {% if sort_by == 'id_emprendimiento' %}selected{% endif %}>ID</option>
                <option value="municipio" {% if sort_by == 'municipio' %}selected{% endif %}>Municipio</option>
            </select>
            <select name="sort_order">
                <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascendente</option>
                <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descendente</option>
            </select>
            <button type="submit">Ordenar</button>
        </form>
    </div>
    <div class="actions">
        <button onclick="openAddModal()">Agregar nuevo emprendimiento</button>
        <button onclick="openEditModal()">Modificar</button>
    </div>
</div>

<!-- Modal para agregar emprendimiento -->
<div id="addEmprendimientoModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddModal()">&times;</span>
        <h2>Agregar Nuevo Emprendimiento</h2>
        <form method="POST" action="{% url 'simulacion:agregar_emprendimiento' %}">
            {% csrf_token %}
            <label for="nombre_emprendimiento">Nombre:</label>
            <input type="text" id="nombre_emprendimiento" name="nombre_emprendimiento" required>
            <label for="descripcion">Descripción:</label>
            <textarea id="descripcion" name="descripcion"></textarea>
            <label for="seguidores">Seguidores:</label>
            <input type="number" id="seguidores" name="seguidores" min="0" value="0" required>
            <label for="id_municipio_origen">Municipio:</label>
            <select id="id_municipio_origen" name="id_municipio_origen" required>
                <option value="">Seleccione un municipio</option>
                {% for municipio in municipios %}
                <option value="{{ municipio.id_municipio }}">{{ municipio.municipio }}</option>
                {% endfor %}
            </select>
            <label for="id_alcance">Alcance:</label>
            <select id="id_alcance" name="id_alcance" required>
                <option value="">Seleccione un alcance</option>
                {% for alcance in alcances %}
                <option value="{{ alcance.id_alcance }}">{{ alcance.tipo }}</option>
                {% endfor %}
            </select>
            <label for="tematicas">Temáticas:</label>
            <select id="tematicas" name="tematicas" multiple required>
                {% for tematica in tematicas %}
                <option value="{{ tematica.id_tematica }}">{{ tematica.nombre }}</option>
                {% endfor %}
            </select>
            <button type="submit">Guardar</button>
        </form>
    </div>
</div>

<!-- Modal para modificar emprendimiento -->
<div id="editEmprendimientoModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Modificar Emprendimiento</h2>
        <form method="POST" action="{% url 'simulacion:modificar_emprendimiento' %}">
            {% csrf_token %}
            <input type="hidden" id="edit_id_emprendimiento" name="id_emprendimiento">
            <label for="edit_nombre_emprendimiento">Nombre:</label>
            <input type="text" id="edit_nombre_emprendimiento" name="nombre_emprendimiento" required>
            <label for="edit_descripcion">Descripción:</label>
            <textarea id="edit_descripcion" name="descripcion"></textarea>
            <label for="edit_seguidores">Seguidores:</label>
            <input type="number" id="edit_seguidores" name="seguidores" min="0" required>
            <label for="edit_id_municipio_origen">Municipio:</label>
            <select id="edit_id_municipio_origen" name="id_municipio_origen" required>
                <option value="">Seleccione un municipio</option>
                {% for municipio in municipios %}
                <option value="{{ municipio.id_municipio }}">{{ municipio.municipio }}</option>
                {% endfor %}
            </select>
            <label for="edit_id_alcance">Alcance:</label>
            <select id="edit_id_alcance" name="id_alcance" required>
                <option value="">Seleccione un alcance</option>
                {% for alcance in alcances %}
                <option value="{{ alcance.id_alcance }}">{{ alcance.tipo }}</option>
                {% endfor %}
            </select>
            <label for="edit_tematicas">Temáticas:</label>
            <select id="edit_tematicas" name="tematicas" multiple required>
                {% for tematica in tematicas %}
                <option value="{{ tematica.id_tematica }}">{{ tematica.nombre }}</option>
                {% endfor %}
            </select>
            <button type="submit">Actualizar</button>
        </form>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Temática</th>
            <th>Municipio</th>
            <th>Alcance</th>
            <th>Seguidores</th>
        </tr>
    </thead>
    <tbody>
        {% for emprendimiento in emprendimientos %}
            <tr
            onclick="handleSelectEmprendimiento(this)"
            data-id="{{ emprendimiento.id_emprendimiento }}"
            data-nombre="{{ emprendimiento.nombre_emprendimiento|escape }}"
            data-descripcion="{{ emprendimiento.descripcion|default_if_none:''|escape }}"
            data-municipio="{{ emprendimiento.id_municipio_origen.id_municipio }}"
            data-alcance="{{ emprendimiento.id_alcance.id_alcance }}"
            data-tematicas='[{% for t in emprendimiento.tematicas.all %}"{{ t.id_tematica }}"{% if not forloop.last %}, {% endif %}{% endfor %}]'
            data-seguidores="{% for seg in emprendimiento.seguidores_set.all %}{{ seg.cantidad }}{% empty %}0{% endfor %}"
            >
            <td data-label="ID">{{ emprendimiento.id_emprendimiento }}</td>
            <td data-label="Nombre">{{ emprendimiento.nombre_emprendimiento }}</td>
            <td data-label="Descripción">{{ emprendimiento.descripcion|default:"Sin descripción" }}</td>
            <td data-label="Temática">{{ emprendimiento.tematicas.all|join:", " }}</td>
            <td data-label="Municipio">{{ emprendimiento.id_municipio_origen.municipio }}</td>
            <td data-label="Alcance">{{ emprendimiento.id_alcance.tipo }}</td>
            <td data-label="Seguidores">{% for seg in emprendimiento.seguidores_set.all %}{{ seg.cantidad }}{% empty %}0{% endfor %}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="7" style="text-align: center;">No hay emprendimientos disponibles.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<style>
    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
        color: #333;
    }
    tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    tr:hover {
        background-color: #f1f1f1;
        cursor: pointer;
    }
    .filters-and-actions {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    .filters form, .sort form {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .filters select, .filters button, .sort select, .sort button {
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .actions button {
        padding: 8px 16px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background-color: #2776F5;
        color: white;
        margin-left: 10px;
    }
    .actions button:hover {
        background-color: #488DFA;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
    }
    .modal-content form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .modal-content input, .modal-content textarea, .modal-content select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .modal-content select[multiple] {
        height: 100px;
    }
    .modal-content button {
        padding: 10px;
        background-color: #2776F5;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .modal-content button:hover {
        background-color: #488DFA;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    @media (max-width: 768px) {
        table, thead, tbody, th, td, tr {
            display: block;
        }
        th, td {
            padding: 10px;
            box-sizing: border-box;
            width: 100%;
        }
        th {
            display: none;
        }
        td {
            text-align: right;
            position: relative;
            padding-left: 50%;
        }
        td:before {
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%;
            font-weight: bold;
            text-align: left;
        }
        .filters form, .sort form {
            flex-direction: column;
        }
        .filters select, .filters button, .sort select, .sort button {
            width: 100%;
        }
        .actions button {
            width: 100%;
            margin-left: 0;
            margin-top: 10px;
        }
        .modal-content {
            width: 90%;
        }
    }
</style>

<script>
    function openAddModal() {
        document.getElementById('addEmprendimientoModal').style.display = 'block';
    }

    function closeAddModal() {
        document.getElementById('addEmprendimientoModal').style.display = 'none';
        document.getElementById('nombre_emprendimiento').value = '';
        document.getElementById('descripcion').value = '';
        document.getElementById('seguidores').value = '0';
        document.getElementById('id_municipio_origen').value = '';
        document.getElementById('id_alcance').value = '';
        document.getElementById('tematicas').value = [];
    }

    function openEditModal() {
        if (!selectedEmprendimiento) {
            alert('Por favor, seleccione un emprendimiento haciendo clic en una fila de la tabla.');
            return;
        }
        document.getElementById('editEmprendimientoModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editEmprendimientoModal').style.display = 'none';
    }

    let selectedEmprendimiento = null;

    function selectEmprendimiento(id, nombre, descripcion, municipio, alcance, tematicas, seguidores) {
        selectedEmprendimiento = { id, nombre, descripcion, municipio, alcance, tematicas, seguidores };
        document.getElementById('edit_id_emprendimiento').value = id;
        document.getElementById('edit_nombre_emprendimiento').value = nombre;
        document.getElementById('edit_descripcion').value = descripcion;
        document.getElementById('edit_seguidores').value = seguidores;
        document.getElementById('edit_id_municipio_origen').value = municipio;
        document.getElementById('edit_id_alcance').value = alcance;
        const tematicasSelect = document.getElementById('edit_tematicas');
        for (let option of tematicasSelect.options) {
            option.selected = tematicas.includes(option.value);
        }
    }

    window.onclick = function(event) {
        if (event.target == document.getElementById('addEmprendimientoModal')) {
            closeAddModal();
        }
        if (event.target == document.getElementById('editEmprendimientoModal')) {
            closeEditModal();
        }
    }

    function handleSelectEmprendimiento(el) {
        const id = el.dataset.id;
        const nombre = el.dataset.nombre;
        const descripcion = el.dataset.descripcion || "";
        const municipio = el.dataset.municipio;
        const alcance = el.dataset.alcance;
        const seguidores = el.dataset.seguidores || "0";
        let tematicas = [];
        try { tematicas = JSON.parse(el.dataset.tematicas || "[]"); } catch (e) {}
        selectEmprendimiento(id, nombre, descripcion, municipio, alcance, tematicas, seguidores);
    }
</script>
{% endblock %}